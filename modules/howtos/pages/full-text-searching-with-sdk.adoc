= Full Text Search (FTS) Using the Node.js SDK with Couchbase Server
:navtitle: Searching from the SDK
:page-topic-type: howto
:imagesdir: ../../assets/images

[abstract]
You can use the Full Text Search service (FTS) to create queryable full-text indexes in Couchbase Server.

Full Text Search (FTS) allows you to create, manage, and query full-text indexes on JSON documents stored in Couchbase buckets.

Using natural language processing for querying documents, FTS provides relevance scoring on the results of your queries, and has fast indexes for querying a wide range of possible text searches.

Supported query types include simple queries like Match and Term queries; range queries like Date Range and Numeric Range; and compound queries for conjunctions, disjunctions, and/or boolean queries.

The Couchbase Node.js SDK exposes an API for performing FTS queries which abstract some of the complexity of using the underlying REST API.

// As of Couchbase Server 6.5, FTS...

== Full Example with Index Creation Illustrated

Search queries are executed at the cluster level (not bucket or collection). Below is a simple MatchQuery that looks for a specified term like “five-star”. 

[source,javascript]
----
const ftsMatchTerm = async(term) => {
  try {
    const queryResult = await cluster.searchQuery(
      'travel-sample-hotel-description',
      couchbase.SearchQuery.match(term),
      { limit: 10 }
    );
    console.log(queryResult)

    return queryResult
  } catch (error) {
    console.error(error)
  }
}

----

The above example will log to the console our return object with its metadata and rows returned, each returned document has an index, id, score and sort value.

== Creating Our Simple FTS Index

To replicate the `travel-sample-hotel-description` FTS index that is used in the code example above, we use the Couchbase Server Web UI, navigate to the Search tab to "Add Index". Select `travel-sample` bucket from the dropdown and set the "Type Identifier" to (JSON type field) adding a value of `type`. 

image::add-fts-index-00.png[Add Index Type Idnetifier,1024,align=left]

Then we "Add Type Mapping" entering a new name of `hotel` and selecting "inherit" from the "default analyzer" dropdown and hit "ok".

image::add-fts-index-02.png[Add Type Mapping for hotel,988,align=left]

With that in place, we can hover over the "hotel" type mapping we just created and click the "+" button and select "Insert Child Field". Add the field value of `description` of type "text" and this populates searchable as `description`. We again select "inherit" from the "default analyzer" dropdown and check all of the field checkboxes.

image::add-fts-index-03.png[Insert Child Field for description,920,align=left]

Next, we click the "+" button to "Insert Child Field" and add the field `name` of type "text" searchable as `name`. Again selecting "inherit" from the "default analyzer" dropdown and also selecting all field checkboxes.

image::add-fts-index-04.png[Insert Child Field for name,918,align=left]

Selecting "Create Index" to finalize our changes. Then We also unchecked the "default" Type mapping as we don't want to scan all types. The index should look like the following:

image::add-fts-index-05.png[Finalize Creation of Index,1020,align=left]

All simple query types are created in the same manner, some have additional properties, which can be seen in common query type descriptions.

Couchbase FTS's xref:6.5@server:fts:fts-query-types.adoc[range of query types] enable powerful searching using multiple options, to ensure results are just within the range wanted.

== Partial Examples Using Other Query Types

Another query type is a date range query that looks for dates between 1st January and the 31st January of the year 2020:

[source,javascript]
----
var result = await cluster.searchQuery(
  'index-name',
  couchbase.SearchQuery.dateRange()
    .start('2020-01-01')
    .end('2020-02-01'),
  { limit: 10 }
);
----

A conjunction query contains multiple child queries; its result documents must satisfy all of the child queries:

[source,javascript]
----
var result = await cluster.searchQuery(
  'index-name',
  couchbase.SearchQuery.conjuncts(
    couchbase.SearchQuery.dateRange()
      .start('2020-01-01')
      .end('2020-02-01'),
    couchbase.SearchQuery.match('five-star')
  ));
----

== Working with Results

As with all query result types in the Node.js SDK, the search query results object contains two properties. The hits reflecting the documents that matched your query, emitted as rows. Along with the metadata available in the meta property.  

Metadata holds additional information not directly related to your query, such as success total hits and how long the query took to execute in the cluster.

[source,javascript]
.Iterating hits
----
result.rows.forEach((hit) => {
  var documentId = hit.id;
  var score = hit.score;
})
----

//[source,csharp]
//.Iterating facets
//----
//result.meta.facets.forEach((facet) => {
//    var name = facet.name;
//    var total = facet.total;
//    // ...
//});
//----

== Consistency

Like the majority of Couchbase query services, FTS allows `RequestPlus` queries --
_Read-Your-Own_Writes (RYOW)_ consistency, ensuring results contain information from
updated indexes:

[source,javascript]
----
var result = cluster.searchQuery(
  'travel-sample-hotel-description',
  couchbase.SearchQuery.match('swanky'),
  { consistency: couchbase.Consistency.RequestPlus }
);
----
